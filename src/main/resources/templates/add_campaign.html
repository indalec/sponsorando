<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>New Campaign - Sponsorando</title>
    <link href="/css/main.css" type="text/css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map { height: 300px; }
        #suggestions { z-index: 1000; }
    </style>
</head>
<body>
<header th:replace="~{fragments/header :: headerSection}" class="container"></header>
<div class="container mt-5">
    <div id="successDivAdd" th:if="${isCampaignAdded}" class="alert alert-success" role="alert">Campaign added successfully</div>
    <h1>Create New Campaign</h1>
    <form th:action="@{/add_campaign}" method="post" class="needs-validation" novalidate>
        <div class="mb-3">
            <label for="title" class="form-label">Title</label>
            <input type="text" class="form-control" id="title" name="title" required>
            <div class="invalid-feedback">
                Please enter a title for your campaign.
            </div>
        </div>
        <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" rows="3" name="description" required></textarea>
            <div class="invalid-feedback">
                Please enter a description of your campaign.
            </div>
        </div>

        <div class="mb-3">
            <label for="startDate" class="form-label">Start Date and Time</label>
            <input type="text" class="form-control flatpickr" id="startDate" name="startDate" required>
            <div class="invalid-feedback">
                Please enter the start date of your campaign.
            </div>
        </div>
        <div class="mb-3">
            <label for="endDate" class="form-label">End Date and Time</label>
            <input type="text" class="form-control flatpickr" id="endDate" name="endDate" required>
            <div class="invalid-feedback">
                Please enter the end date of your campaign.
            </div>
        </div>
        <div class="mb-3">
            <label for="goalAmount" class="form-label">Goal Amount</label>
            <input type="number" min="1" step="0.01" class="form-control" id="goalAmount" name="goalAmount" required>
            <div class="invalid-feedback">
                Please enter the amount you want to raise for your campaign.
            </div>
        </div>
        <div class="mb-3">
            <label for="categories" class="form-label">Categories</label>
            <select class="form-control" id="categories" name="categories" multiple required>
                <option th:each="category : ${categories}" th:value="${category.id}" th:text="${category.name}"></option>
            </select>
            <div class="invalid-feedback">
                Please select the categories for your campaign (hold ctrl to multi-select).
            </div>
        </div>

        <hr>
        <h4>Address Information</h4>
        <p>You can enter your address using the <strong>search bar</strong> OR manually fill in the fields below.</p>

        <div class="mb-3">
            <label for="address" class="form-label">Search Address (Optional)</label>
            <input type="text" class="form-control" id="address" placeholder="Start typing an address..." autocomplete="off">
            <ul id="suggestions" class="list-group position-absolute w-100"></ul>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="inputStreet" class="form-label">Street</label>
                <input type="text" class="form-control validate-address" id="inputStreet" name="street" required>
                <div class="invalid-feedback">Please enter a street.</div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="inputNumber" class="form-label">Number</label>
                <input type="text" class="form-control validate-address" id="inputNumber" name="number" required>
                <div class="invalid-feedback">Please enter a number.</div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="inputCity" class="form-label">City</label>
                <input type="text" class="form-control validate-address" id="inputCity" name="city" required>
                <div class="invalid-feedback">Please enter a city.</div>
            </div>
            <div class="col-md-6 mb-3">
                <label for="inputPostcode" class="form-label">Postcode</label>
                <input type="text" class="form-control validate-address" id="inputPostcode" name="postcode" required>
                <div class="invalid-feedback">Please enter a postcode.</div>
            </div>
        </div>

        <div class="mb-3">
            <label for="inputCountry" class="form-label">Country</label>
            <input type="text" class="form-control validate-address" id="inputCountry" name="country" required>
            <div class="invalid-feedback">Please enter a country.</div>
        </div>

        <input type="hidden" id="latitude" name="latitude">
        <input type="hidden" id="longitude" name="longitude">

        <div id="map" class="mb-3"></div>

        <button type="submit" class="btn btn-primary">Create Campaign</button>
    </form>
</div>
<footer th:replace="~{fragments/footer :: footerSection}" role="contentinfo" class="footer"></footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const fields = ["inputStreet", "inputNumber", "inputCity", "inputPostcode", "inputCountry"];
        const addressInput = document.getElementById("address");
        const suggestionsList = document.getElementById("suggestions");
        let manualInput = false;  // Flag to check if user is manually entering address
        let map = L.map('map').setView([0, 0], 2);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        let marker;

        function updateMap(lat, lon) {
            if (marker) map.removeLayer(marker);
            marker = L.marker([lat, lon]).addTo(map);
            map.setView([lat, lon], 13);
            document.getElementById("latitude").value = lat;
            document.getElementById("longitude").value = lon;
        }

        async function validateAddress() {
            if (manualInput) return; // If user manually enters address, don't override it

            let address = fields.map(id => document.getElementById(id).value).filter(val => val).join(", ");
            if (address.length < 5) return;

            let response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&addressdetails=1`);
            let data = await response.json();

            if (data.length > 0) {
                updateMap(data[0].lat, data[0].lon);
            }
        }

        addressInput.addEventListener("input", async function() {
            let query = this.value.trim();
            if (query.length < 3) return;

            let response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&addressdetails=1`);
            let data = await response.json();
            suggestionsList.innerHTML = "";

            if (data.length === 0) return;

            data.forEach(place => {
                let li = document.createElement("li");
                li.textContent = place.display_name;
                li.classList.add("list-group-item");
                li.onclick = () => {
                    manualInput = false; // Reset manual input mode
                    addressInput.value = place.display_name;
                    suggestionsList.innerHTML = "";

                    // Autofill structured address fields
                    document.getElementById("inputStreet").value = place.address.road || "";
                    document.getElementById("inputNumber").value = place.address.house_number || "";
                    document.getElementById("inputCity").value = place.address.city || place.address.town || place.address.village || "";
                    document.getElementById("inputPostcode").value = place.address.postcode || "";
                    document.getElementById("inputCountry").value = place.address.country || "";

                    updateMap(place.lat, place.lon);
                };
                suggestionsList.appendChild(li);
            });
        });

        // Initialize Flatpickr for start date picker
        const startDatePicker = flatpickr("#startDate", {
            enableTime: true,
            dateFormat: "d/m/Y H:i",
            time_24hr: true,
            minDate: "today",
            onChange: function(selectedDates, dateStr, instance) {
                endDatePicker.set('minDate', dateStr);
            }
        });

        // Initialize Flatpickr for end date picker
        const endDatePicker = flatpickr("#endDate", {
            enableTime: true,
            dateFormat: "d/m/Y H:i",
            time_24hr: true,
            minDate: "today"
        });

        const form = document.querySelector('form');
        const startDateInput = document.getElementById("startDate");
        const endDateInput = document.getElementById("endDate");

        function validateDates() {
            const startDate = startDatePicker.selectedDates[0];
            const endDate = endDatePicker.selectedDates[0];

            if (!startDate || !endDate) {
                return false;
            }

            if (endDate <= startDate) {
                endDateInput.classList.add("is-invalid");
                endDateInput.nextElementSibling.textContent = "End date must be later than the start date.";
                return false;
            } else {
                endDateInput.classList.remove("is-invalid");
                return true;
            }
        }

        endDateInput.addEventListener('change', validateDates);

        form.addEventListener('submit', function(event) {
            if (!startDatePicker.selectedDates[0]) {
                startDateInput.classList.add("is-invalid");
                event.preventDefault();
                event.stopPropagation();
            } else {
                startDateInput.classList.remove("is-invalid");
            }

            if (!endDatePicker.selectedDates[0]) {
                endDateInput.classList.add("is-invalid");
                event.preventDefault();
                event.stopPropagation();
            } else if (!validateDates()) {
                event.preventDefault();
                event.stopPropagation();
            }
        });

        document.getElementById("goalAmount").addEventListener("input", function (event) {
            let inputField = event.target;
            let value = inputField.value.trim();
            let errorMessage = "";

            // Ensure the value is a valid currency format
            if (value === "") {
                errorMessage = "Please enter the amount you want to raise for your campaign.";
            } else if (!/^\d+(\.\d{1,2})?$/.test(value)) {
                errorMessage = "Please enter a valid number in currency format (e.g., 10.00).";
            } else if (parseFloat(value) < 10) {
                errorMessage = "The minimum goal amount must be at least 10.";
            } else if (parseFloat(value) <= 0) {
                errorMessage = "Please enter a positive amount greater than zero.";
            }

            // Display or remove error message
            if (errorMessage) {
                inputField.classList.add("is-invalid");
                inputField.nextElementSibling.textContent = errorMessage; // Set the error message
            } else {
                inputField.classList.remove("is-invalid");
                inputField.classList.add("is-valid");
                inputField.nextElementSibling.textContent = ""; // Remove error message
            }
        });

        (() => {
            'use strict'

            // Fetch all the forms we want to apply custom Bootstrap validation styles to
            const forms = document.querySelectorAll('.needs-validation')

            // Loop over them and prevent submission
            Array.from(forms).forEach(form => {
                form.addEventListener('submit', event => {
                    if (!form.checkValidity()) {
                        event.preventDefault()
                        event.stopPropagation()
                    }

                    form.classList.add('was-validated')
                }, false)
            })
        })();

        // Add event listeners for manual address input
        fields.forEach(field => {
            document.getElementById(field).addEventListener("input", () => {
                manualInput = true;
                validateAddress();
            });
        });
    });
</script>
<script src="/js/action_notifications.js"></script>
</body>
</html>
