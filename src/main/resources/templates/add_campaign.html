<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>New Campaign - Sponsorando</title>
    <link href="/css/main.css" type="text/css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
<header th:replace="~{fragments/header :: headerSection}" class="container"></header>
<div class="container mt-5">
    <h1>Create New Campaign</h1>
    <form th:action="@{/add_campaign}" method="post" th:object="${campaignForm}"  class="needs-validation" novalidate>
        <div class="mb-3">
            <label for="title" class="form-label">Title</label>
            <input type="text" class="form-control" id="title" name="title" required>
            <div class="invalid-feedback">
                Please enter a title for your campaign.
            </div>
        </div>
        <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" rows="3" name="description" required></textarea>
            <div class="invalid-feedback">
                Please enter a description of your campaign.
            </div>
        </div>

        <div class="mb-3">
            <label for="startDate" class="form-label">Start Date and Time</label>
            <input type="text" class="form-control flatpickr" id="startDate" name="startDate" required>
            <div class="invalid-feedback">
                Please enter the start date of your campaign.
            </div>
        </div>
        <div class="mb-3">
            <label for="endDate" class="form-label">End Date and Time</label>
            <input type="text" class="form-control flatpickr" id="endDate" name="endDate" required>
            <div class="invalid-feedback">
                Please enter the end date of your campaign.
            </div>
        </div>
        <div class="mb-3">
            <label for="goalAmount" class="form-label">Goal Amount</label>
            <input type="number" min="1" step="0.01" class="form-control" id="goalAmount" name="goalAmount" required>
            <div class="invalid-feedback">
                Please enter the amount you want to raise for your campaign.
            </div>
        </div>
        <div class="mb-3">
            <label for="categories" class="form-label">Categories</label>
            <select class="form-control" id="categories" name="categories" multiple required>

                <option th:each="category : ${categories}" th:value="${category.id}" th:text="${category.name}"></option>
            </select>
            <div class="invalid-feedback">
                Please select the categories for your campaign (hold ctrl to multi-select).
            </div>
        </div>
        <button type="submit" class="btn btn-primary">Create Campaign</button>
    </form>
</div>
<footer th:replace="~{fragments/footer :: footerSection}" role="contentinfo" class="footer"></footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Flatpickr for date and time pickers
        flatpickr(".flatpickr", {
            enableTime: true,
            dateFormat: "d/m/Y H:i",
            time_24hr: true,
            minDate: "today"
        });

        const form = document.querySelector('form');
        const startDateInput = document.getElementById("startDate");
        const endDateInput = document.getElementById("endDate");

        function validateDates() {
            const startDate = flatpickr.parseDate(startDateInput.value, "d/m/Y H:i");
            const endDate = flatpickr.parseDate(endDateInput.value, "d/m/Y H:i");

            startDateInput.classList.remove("is-invalid", "is-valid");
            endDateInput.classList.remove("is-invalid", "is-valid");

            if (!startDate || !endDate) {
                return false;
            }

            if (endDate <= startDate) {
                endDateInput.classList.add("is-invalid");
                endDateInput.nextElementSibling.textContent = "End date must be later than the start date.";
                return false;
            } else {
                startDateInput.classList.add("is-valid");
                endDateInput.classList.add("is-valid");
                endDateInput.nextElementSibling.textContent = "";
                return true;
            }
        }

        endDateInput.addEventListener('change', validateDates);

        form.addEventListener('submit', function(event) {
            if (!validateDates()) {
                event.preventDefault();
                event.stopPropagation();
            }
        });
    });

    document.getElementById("goalAmount").addEventListener("input", function (event) {
        let inputField = event.target;
        let value = inputField.value.trim();
        let errorMessage = "";

        // Ensure the value is a valid currency format
        if (value === "") {
            errorMessage = "Please enter the amount you want to raise for your campaign.";
        } else if (!/^\d+(\.\d{1,2})?$/.test(value)) {
            errorMessage = "Please enter a valid number in currency format (e.g., 10.00).";
        } else if (parseFloat(value) < 10) {
            errorMessage = "The minimum goal amount must be at least 10.";
        } else if (parseFloat(value) <= 0) {
            errorMessage = "Please enter a positive amount greater than zero.";
        }

        // Display or remove error message
        if (errorMessage) {
            inputField.classList.add("is-invalid");
            inputField.nextElementSibling.textContent = errorMessage; // Set the error message
        } else {
            inputField.classList.remove("is-invalid");
            inputField.classList.add("is-valid");
            inputField.nextElementSibling.textContent = ""; // Remove error message
        }
    });

    (() => {
        'use strict'

        // Fetch all the forms we want to apply custom Bootstrap validation styles to
        const forms = document.querySelectorAll('.needs-validation')

        // Loop over them and prevent submission
        Array.from(forms).forEach(form => {
            form.addEventListener('submit', event => {
                if (!form.checkValidity()) {
                    event.preventDefault()
                    event.stopPropagation()
                }

                form.classList.add('was-validated')
            }, false)
        })
    })();
</script>
</body>
</html>